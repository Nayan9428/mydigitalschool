<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рк╕рлНркорк╛рк░рлНркЯ ркЧрлБркгрккркдрлНрк░ркХ ркорлЗркирлЗркЬрк░ | Shikshan Sagar</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Vadodara:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #1e3a8a; 
            --secondary: #3b82f6; 
            --accent: #f59e0b; 
            --bg: #f8fafc;
            --text: #1e293b;
        }

        body { 
            font-family: 'Hind Vadodara', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 20px; 
            color: var(--text);
        }

        /* ркХркВркЯрлНрк░рлЛрк▓ рккрлЗркирк▓ рк╕рлНркЯрк╛ркЗрк▓ */
        .admin-panel {
            background: white;
            max-width: 1100px;
            margin: 0 auto 30px auto;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-top: 8px solid var(--primary);
        }

        .panel-title {
            color: var(--primary);
            text-align: center;
            margin-bottom: 25px;
            font-size: 28px;
        }

        .grid-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label { font-weight: 600; color: #475569; }

        input, textarea, select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: 0.3s;
            outline: none;
        }

        input:focus { border-color: var(--secondary); }

        /* рккрлНрк░рк╢рлНрки рк╕рлЗркЯрк░ */
        .q-setter {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f1f5f9;
            padding: 5px 15px;
            border-radius: 50px;
            width: fit-content;
        }

        .q-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-size: 18px;
        }

        /* рк╕ркмрлНркЬрлЗркХрлНркЯ ркЯрлЗркЧрлНрк╕ */
        .subject-manager {
            margin: 20px 0;
            padding: 15px;
            background: #fdf2f2;
            border-radius: 15px;
        }

        .subject-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .tag {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #cbd5e1;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tag.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .add-subject-box {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ркмркЯркирлНрк╕ */
        .action-btns {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-pdf { background: #ef4444; }
        .btn-excel { background: #10b981; }
        .btn-save { background: #f59e0b; }
        .btn-load { background: #8b5cf6; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* рккрлНрк░рк┐ркирлНркЯ ркПрк░рк┐ркпрк╛ рк╕рлНркЯрк╛ркЗрк▓ */
        #outputArea { margin-top: 20px; }

        .print-page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 0 auto 30px auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            box-sizing: border-box;
            position: relative;
        }

        .header-box {
            text-align: center;
            border-bottom: 3px double var(--primary);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .header-box h1 { margin: 0; color: var(--primary); font-size: 24px; }
        .header-box h3 { margin: 5px 0; font-weight: normal; }

        .info-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1.5px solid black;
        }

        th, td {
            border: 1px solid black;
            padding: 6px 2px;
            text-align: center;
            font-size: 13px;
        }

        thead { background: #f1f5f9; }

        .col-sr { width: 35px; }
        .col-name { width: 220px; text-align: left; padding-left: 8px; }
        .col-total { width: 50px; font-weight: bold; background: #fff7ed; }

        .mark-input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-weight: bold;
            outline: none;
            -moz-appearance: textfield;
        }
        .mark-input::-webkit-outer-spin-button,
        .mark-input::-webkit-inner-spin-button { -webkit-appearance: none; }

        .footer-credit {
            position: absolute;
            bottom: 10mm;
            right: 15mm;
            font-size: 10px;
            color: #64748b;
            font-weight: bold;
        }

        @media print {
            body { padding: 0; background: white; }
            .admin-panel { display: none; }
            .print-page { margin: 0; box-shadow: none; border: none; width: 100%; }
            .mark-input { border: none; }
        }
    </style>
</head>
<body>

<div class="admin-panel no-print">
    <div class="panel-title">ЁЯЪА рк╕рлНркорк╛рк░рлНркЯ ркЧрлБркгрккркдрлНрк░ркХ ркорлЗркирлЗркЬрк░</div>
    
    <div class="grid-inputs">
        <div class="input-group">
            <label>рк╢рк╛рк│рк╛ркирлБркВ ркирк╛рко</label>
            <input type="text" id="schName" placeholder="ркдркорк╛рк░рлА рк╢рк╛рк│рк╛ркирлБркВ ркирк╛рко ркЕрк╣рлАркВ рк▓ркЦрлЛ..." oninput="renderTables()">
        </div>
        <div class="input-group">
            <label>ркХрк╕рлЛркЯрлАркирлБркВ ркирк╛рко</label>
            <input type="text" id="testName" placeholder="ркжрк╛.ркд. рккрлНрк░ркерко рк╕ркдрлНрк░рк╛ркВркд ркХрк╕рлЛркЯрлА" oninput="renderTables()">
        </div>
        <div class="input-group">
            <label>ркзрлЛрк░ркг / рк╡рк░рлНркЧ</label>
            <input type="text" id="stdName" placeholder="ркжрк╛.ркд. ркзрлЛрк░ркг-рло (ркЕ)" oninput="renderTables()">
        </div>
        <div class="input-group">
            <label>ркдрк╛рк░рлАркЦ</label>
            <input type="text" id="reportDate" placeholder="ркдрк╛рк░рлАркЦ рк▓ркЦрлЛ (ркжрк╛.ркд. рлирли/рлжрлк/рлирлжрлирлк)">
        </div>
    </div>

    <div style="display: flex; gap: 30px; align-items: flex-end; flex-wrap: wrap;">
        <div class="input-group">
            <label>рккрлНрк░рк╢рлНркирлЛркирлА рк╕ркВркЦрлНркпрк╛ (рлз ркерлА рлирлл)</label>
            <div class="q-setter">
                <button class="q-btn" onclick="changeQ(-1)">тИТ</button>
                <input type="number" id="queCount" value="10" style="width: 40px; text-align: center; border: none; background: transparent; font-weight: bold;" readonly>
                <button class="q-btn" onclick="changeQ(1)">+</button>
            </div>
        </div>
        <button class="btn" style="background: #0ea5e9;" onclick="setCurrentDate()">ЁЯУЕ ркЖркЬркирлА ркдрк╛рк░рлАркЦ</button>
    </div>

    <div class="subject-manager">
        <label>рк╡рк┐рк╖ркпрлЛ рккрк╕ркВркж ркХрк░рлЛ (ркЕркерк╡рк╛ ркирк╡рлЛ ркЙркорлЗрк░рлЛ):</label>
        <div class="subject-tags" id="subjectList"></div>
        <div class="add-subject-box">
            <input type="text" id="newSubInput" placeholder="ркирк╡рлЛ рк╡рк┐рк╖ркп рк▓ркЦрлЛ...">
            <button class="btn" style="background: var(--primary); padding: 8px 15px;" onclick="addNewSubject()">+ ркЙркорлЗрк░рлЛ</button>
        </div>
    </div>

    <div class="input-group">
        <label>рк╡рк┐ркжрлНркпрк╛рк░рлНркерлАркУркирк╛ ркирк╛рко (ркПркХ рк▓рк╛ркИркиркорк╛ркВ ркПркХ ркирк╛рко)</label>
        <textarea id="nameInput" rows="5" placeholder="ркЕрк╣рлАркВ рк╡рк┐ркжрлНркпрк╛рк░рлНркерлАркУркирк╛ ркирк╛рко рккрлЗрк╕рлНркЯ ркХрк░рлЛ..." oninput="renderTables()"></textarea>
    </div>

    <div class="action-btns">
        <button class="btn btn-pdf" onclick="generatePDF()">ЁЯУД PDF ркбрк╛ркЙркирк▓рлЛркб</button>
        <button class="btn btn-excel" onclick="generateExcel()">ЁЯУК Excel ркбрк╛ркЙркирк▓рлЛркб</button>
        <button class="btn btn-save" onclick="exportData()">ЁЯУе Backup рк╕рлЗрк╡</button>
        <button class="btn btn-load" onclick="document.getElementById('importFile').click()">ЁЯУд Restore рк▓рлЛркб</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
</div>

<div id="outputArea"></div>

<script>
// ркбрк┐рклрлЛрк▓рлНркЯ рк╡рк┐рк╖ркпрлЛркирлА ркпрк╛ркжрлА
let allSubjects = ["ркЧрлБркЬрк░рк╛ркдрлА", "ркЧркгрк┐ркд", "ркЕркВркЧрлНрк░рлЗркЬрлА", "рк╣рк┐ркирлНркжрлА", "рк╡рк┐ркЬрлНркЮрк╛рки", "рк╕рк╛ркорк╛ркЬрк┐ркХ рк╡рк┐ркЬрлНркЮрк╛рки", "рк╕ркВрк╕рлНркХрлГркд", "рккрк░рлНркпрк╛рк╡рк░ркг", "ркЪрк┐ркдрлНрк░ркХрк╛рко"];
let selectedSubjects = ["ркЧрлБркЬрк░рк╛ркдрлА", "ркЧркгрк┐ркд"];

function init() {
    renderSubjectTags();
    renderTables();
}

// рк╕ркмрлНркЬрлЗркХрлНркЯ ркЯрлЗркЧрлНрк╕ рк░рлЗркирлНркбрк░ ркХрк░рк╡рк╛
function renderSubjectTags() {
    const container = document.getElementById('subjectList');
    container.innerHTML = "";
    allSubjects.forEach(sub => {
        let tag = document.createElement('span');
        tag.className = `tag ${selectedSubjects.includes(sub) ? 'active' : ''}`;
        tag.innerHTML = `${sub}`;
        tag.onclick = function() {
            if(selectedSubjects.includes(sub)) {
                selectedSubjects = selectedSubjects.filter(s => s !== sub);
            } else {
                selectedSubjects.push(sub);
            }
            renderSubjectTags();
            renderTables();
        };
        container.appendChild(tag);
    });
}

// ркирк╡рлЛ рк╡рк┐рк╖ркп ркЙркорлЗрк░рк╡рлЛ
function addNewSubject() {
    const input = document.getElementById('newSubInput');
    const val = input.value.trim();
    if(val && !allSubjects.includes(val)) {
        allSubjects.push(val);
        selectedSubjects.push(val);
        input.value = "";
        renderSubjectTags();
        renderTables();
    }
}

function changeQ(val) {
    let qInput = document.getElementById('queCount');
    let current = parseInt(qInput.value);
    let newVal = current + val;
    if(newVal >= 1 && newVal <= 25) {
        qInput.value = newVal;
        renderTables();
    }
}

function setCurrentDate() {
    const today = new Date();
    const formatted = today.getDate().toString().padStart(2, '0') + '/' + 
                      (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                      today.getFullYear();
    document.getElementById('reportDate').value = formatted;
    renderTables();
}

function renderTables() {
    const school = document.getElementById('schName').value || "рк╢рк╛рк│рк╛ркирлБркВ ркирк╛рко";
    const test = document.getElementById('testName').value || "ркХрк╕рлЛркЯрлАркирлБркВ ркирк╛рко";
    const std = document.getElementById('stdName').value || "ркзрлЛрк░ркг";
    const dateVal = document.getElementById('reportDate').value || "___/___/______";
    const qCount = parseInt(document.getElementById('queCount').value);
    const names = document.getElementById('nameInput').value.split('\n').filter(n => n.trim() !== "");
    const container = document.getElementById('outputArea');
    
    // ркЬрлБркирлЛ ркбрлЗркЯрк╛ рк╕рк╛ркЪрк╡рлА рк░рк╛ркЦрк╡рк╛ ркорк╛ркЯрлЗ
    const oldData = {};
    document.querySelectorAll(".student-row").forEach(row => {
        const subKey = row.dataset.subject;
        const nIdx = row.dataset.nidx;
        const key = `${subKey}-${nIdx}`;
        oldData[key] = Array.from(row.querySelectorAll(".mark-input")).map(input => input.value);
    });

    container.innerHTML = "";

    if(selectedSubjects.length === 0) {
        container.innerHTML = "<p style='text-align:center; color:grey;'>ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркЙрккрк░ркерлА ркУркЫрк╛ркорк╛ркВ ркУркЫрлЛ ркПркХ рк╡рк┐рк╖ркп рккрк╕ркВркж ркХрк░рлЛ.</p>";
        return;
    }

    selectedSubjects.forEach((sub) => {
        let section = document.createElement('div');
        section.className = 'print-page';
        
        let displayCount = names.length > 0 ? names.length : 10;
        let rowHtml = "";

        for (let nIdx = 0; nIdx < displayCount; nIdx++) {
            const studentName = names[nIdx] || "";
            const key = `${sub}-${nIdx}`;
            const marks = oldData[key] || Array(qCount).fill("");
            
            rowHtml += `
                <tr class="student-row" data-subject="${sub}" data-nidx="${nIdx}">
                    <td class="col-sr">${nIdx + 1}</td>
                    <td class="col-name">${studentName}</td>
                    ${Array.from({length: qCount}, (_, i) => `
                        <td><input type="number" class="mark-input" value="${marks[i] || ''}" oninput="calcTotal(this)"></td>
                    `).join('')}
                    <td class="col-total">0</td>
                </tr>`;
        }

        section.innerHTML = `
            <div class="header-box">
                <h1>${school}</h1>
                <h3>${test}</h3>
            </div>
            <div class="info-bar">
                <span>рк╡рк┐рк╖ркп: ${sub}</span>
                <span>ркзрлЛрк░ркг: ${std}</span>
                <span>ркдрк╛рк░рлАркЦ: ${dateVal}</span>
            </div>
            <table>
                <thead>
                    <tr>
                        <th rowspan="2" class="col-sr">ркХрлНрк░рко</th>
                        <th rowspan="2" class="col-name">рк╡рк┐ркжрлНркпрк╛рк░рлНркерлАркирлБркВ ркирк╛рко</th>
                        <th colspan="${qCount}">ркорлЗрк│рк╡рлЗрк▓ ркЧрлБркг (рккрлНрк░рк╢рлНрки ркорлБркЬркм)</th>
                        <th rowspan="2" class="col-total">ркХрлБрк▓</th>
                    </tr>
                    <tr>${Array.from({length:qCount}, (_, i) => `<th>${i+1}</th>`).join('')}</tr>
                </thead>
                <tbody>${rowHtml}</tbody>
            </table>
            <div class="footer-credit">Created By: Shikshan Sagar Application</div>
        `;
        container.appendChild(section);
        
        // ркЯрлЛркЯрк▓ ркЧркгркдрк░рлА
        section.querySelectorAll(".student-row").forEach(row => {
            const input = row.querySelector(".mark-input");
            if(input) calcTotal(input);
        });
    });
}

function calcTotal(input) {
    const row = input.closest('tr');
    let sum = 0;
    row.querySelectorAll('.mark-input').forEach(i => {
        sum += parseFloat(i.value) || 0;
    });
    row.querySelector('.col-total').innerText = sum;
}

// PDF ркЬркирк░рлЗркЯ рклркВркХрлНрк╢рки
function generatePDF() {
    const element = document.getElementById('outputArea');
    const opt = {
        margin: [0, 0],
        filename: 'Gunpatrak_' + (new Date().getTime()) + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
}

// EXCEL ркЬркирк░рлЗркЯ рклркВркХрлНрк╢рки
function generateExcel() {
    const wb = XLSX.utils.book_new();
    document.querySelectorAll('.print-page').forEach((page, i) => {
        const subName = selectedSubjects[i] || `Sheet${i+1}`;
        const table = page.querySelector('table');
        const ws = XLSX.utils.table_to_sheet(table);
        XLSX.utils.book_append_sheet(wb, ws, subName.substring(0, 30));
    });
    XLSX.writeFile(wb, "Gunpatrak_Data.xlsx");
}

// ркбрлЗркЯрк╛ ркмрлЗркХркЕркк рклркВркХрлНрк╢рки
function exportData() {
    const data = {
        sch: document.getElementById('schName').value,
        test: document.getElementById('testName').value,
        std: document.getElementById('stdName').value,
        dt: document.getElementById('reportDate').value,
        qc: document.getElementById('queCount').value,
        names: document.getElementById('nameInput').value,
        subjects: selectedSubjects,
        marks: {}
    };

    document.querySelectorAll(".student-row").forEach(row => {
        const key = `${row.dataset.subject}-${row.dataset.nidx}`;
        data.marks[key] = Array.from(row.querySelectorAll(".mark-input")).map(i => i.value);
    });

    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "Gunpatrak_Backup.json";
    a.click();
}

// ркмрлЗркХркЕркк рк░рк┐рк╕рлНркЯрлЛрк░ рклркВркХрлНрк╢рки
function importData(event) {
    const reader = new FileReader();
    reader.onload = function(){
        const d = JSON.parse(reader.result);
        document.getElementById('schName').value = d.sch || "";
        document.getElementById('testName').value = d.test || "";
        document.getElementById('stdName').value = d.std || "";
        document.getElementById('reportDate').value = d.dt || "";
        document.getElementById('queCount').value = d.qc || 10;
        document.getElementById('nameInput').value = d.names || "";
        selectedSubjects = d.subjects || [];
        
        renderSubjectTags();
        renderTables();

        setTimeout(() => {
            Object.keys(d.marks).forEach(key => {
                const parts = key.split('-');
                const sub = parts[0];
                const idx = parts[1];
                const row = document.querySelector(`.student-row[data-subject="${sub}"][data-nidx="${idx}"]`);
                if(row) {
                    const inputs = row.querySelectorAll(".mark-input");
                    d.marks[key].forEach((val, i) => {
                        if(inputs[i]) inputs[i].value = val;
                    });
                    calcTotal(inputs[0]);
                }
            });
        }, 500);
    };
    reader.readAsText(event.target.files[0]);
}

window.onload = init;
</script>

</body>
</html>